# æ¸…ç†ç­–ç•¥ä¼˜åŒ–å®æ–½è®¡åˆ’

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

æ ¹æ® `CLEANUP_STRATEGIES_EVALUATION.md` çš„è¯„ä¼°ï¼Œè§£å†³ä»¥ä¸‹é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼š

1. âœ… **æ’åºç®—æ³•æ€§èƒ½** - ç¼“å­˜æ’åºç»“æœ
2. âœ… **æ•°æ®åº“æŸ¥è¯¢é‡å¤** - æ¶ˆé™¤é‡å¤æŸ¥è¯¢
3. âœ… **æ–‡ä»¶è¿‡é•¿** - æ‹†åˆ†æ–‡ä»¶
4. âœ… **äº‹åŠ¡ä¼˜åŒ–** - å‡å°‘ session æŒæœ‰æ—¶é—´

---

## ğŸ“‹ ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ’åºç®—æ³•ä¼˜åŒ– â­â­â­â­â­

#### é—®é¢˜
- æ¯æ¬¡ `execute_due_strategies()` éƒ½é‡æ–°æ’åº
- å³ä½¿æ²¡æœ‰ç­–ç•¥éœ€è¦æ‰§è¡Œï¼Œä¹Ÿä¼šæ‰§è¡Œæ’åº
- æ—¶é—´å¤æ‚åº¦ O(V + E)ï¼Œä½†æ¯æ¬¡æ‰§è¡Œéƒ½é‡å¤è®¡ç®—

#### è§£å†³æ–¹æ¡ˆ
- **ç¼“å­˜æ’åºç»“æœ** - ç­–ç•¥æ³¨å†Œæ—¶è®¡ç®—ä¸€æ¬¡
- **æƒ°æ€§è®¡ç®—** - åªåœ¨éœ€è¦æ—¶æ’åº
- **å¤±æ•ˆæœºåˆ¶** - ç­–ç•¥æ³¨å†Œ/æ³¨é”€æ—¶å¤±æ•ˆç¼“å­˜

#### å®ç°
```python
class CleanupStrategyManager:
    def __init__(self, ...):
        self.strategies = {}
        self._sorted_strategies_cache: Optional[List[BaseCleanupStrategy]] = None
        self._cache_version = 0  # ç¼“å­˜ç‰ˆæœ¬å·
    
    def register(self, strategy):
        self.strategies[strategy.name] = strategy
        self._invalidate_sort_cache()  # å¤±æ•ˆç¼“å­˜
    
    def unregister(self, strategy_name):
        if strategy_name in self.strategies:
            del self.strategies[strategy_name]
            self._invalidate_sort_cache()  # å¤±æ•ˆç¼“å­˜
    
    def _invalidate_sort_cache(self):
        """å¤±æ•ˆæ’åºç¼“å­˜"""
        self._sorted_strategies_cache = None
    
    def _get_sorted_strategies(self) -> List[BaseCleanupStrategy]:
        """è·å–æ’åºåçš„ç­–ç•¥ï¼ˆæƒ°æ€§è®¡ç®— + ç¼“å­˜ï¼‰"""
        if self._sorted_strategies_cache is None:
            self._sorted_strategies_cache = self._sort_strategies_by_priority()
        return self._sorted_strategies_cache
```

---

### 2. æ•°æ®åº“æŸ¥è¯¢é‡å¤ä¼˜åŒ– â­â­â­â­

#### é—®é¢˜
- `before_execute()` æ‰§è¡Œ `count()` æŸ¥è¯¢
- `_do_cleanup()` æ‰§è¡Œç›¸åŒçš„ `all()` æŸ¥è¯¢
- ä¸¤æ¬¡æŸ¥è¯¢æ¡ä»¶å‡ ä¹ç›¸åŒ

#### è§£å†³æ–¹æ¡ˆ
**æ–¹æ¡ˆ A: ç§»é™¤ before_execute ä¸­çš„ count æŸ¥è¯¢ï¼ˆæ¨èï¼‰**

ç†ç”±ï¼š
- `_do_cleanup()` ä¼šè¿”å›å®é™…æ¸…ç†æ•°é‡
- å¦‚æœæ•°é‡ä¸º 0ï¼Œå½±å“å¾ˆå°
- å‡å°‘ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢

**æ–¹æ¡ˆ B: åˆå¹¶æŸ¥è¯¢é€»è¾‘**

å¦‚æœç¡®å®éœ€è¦å‰ç½®æ£€æŸ¥ï¼Œå¯ä»¥ï¼š
- åœ¨ `before_execute` ä¸­æŸ¥è¯¢å¹¶ç¼“å­˜ç»“æœ
- `_do_cleanup` ä½¿ç”¨ç¼“å­˜çš„ç»“æœ

---

### 3. æ–‡ä»¶æ‹†åˆ† â­â­â­

#### å½“å‰ç»“æ„
```
cleanup_strategies.py (854è¡Œ)
â”œâ”€ è£…é¥°å™¨å’Œå…ƒæ•°æ®
â”œâ”€ è§‚å¯Ÿè€…
â”œâ”€ æ ¸å¿ƒæ•°æ®ç»“æ„
â”œâ”€ ç­–ç•¥åŸºç±»
â”œâ”€ å…·ä½“ç­–ç•¥å®ç° (4ä¸ªç­–ç•¥)
â”œâ”€ ç®¡ç†å™¨
â”œâ”€ é…ç½®åŠ è½½
â””â”€ å·¥å…·å‡½æ•°
```

#### æ‹†åˆ†æ–¹æ¡ˆ
```
scheduler/cleanup_strategies/
â”œâ”€ __init__.py
â”œâ”€ base.py          # åŸºç±»ã€å…ƒæ•°æ®ã€è£…é¥°å™¨
â”œâ”€ observers.py     # è§‚å¯Ÿè€…
â”œâ”€ strategies.py    # å…·ä½“ç­–ç•¥å®ç°
â”œâ”€ manager.py       # ç®¡ç†å™¨
â”œâ”€ config.py        # é…ç½®åŠ è½½
â””â”€ types.py         # ç±»å‹å®šä¹‰ï¼ˆCleanupResultç­‰ï¼‰
```

---

### 4. äº‹åŠ¡ä¼˜åŒ– â­â­â­â­

#### é—®é¢˜
- æ‰€æœ‰ç­–ç•¥å…±äº«ä¸€ä¸ª session
- session æŒæœ‰æ—¶é—´è¿‡é•¿ï¼ˆä»å¼€å§‹åˆ°æ‰€æœ‰ç­–ç•¥æ‰§è¡Œå®Œï¼‰
- å¦‚æœæŸä¸ªç­–ç•¥æ‰§è¡Œæ…¢ï¼Œä¼šé˜»å¡å…¶ä»–ç­–ç•¥

#### è§£å†³æ–¹æ¡ˆ
**æ¯ä¸ªç­–ç•¥ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡**

```python
def execute_due_strategies(self, current_time: int) -> List[CleanupResult]:
    results = []
    due_strategies = [...]
    
    # æ¯ä¸ªç­–ç•¥ä½¿ç”¨ç‹¬ç«‹ sessionï¼ˆäº‹åŠ¡éš”ç¦»ï¼‰
    for strategy in due_strategies:
        with sync_db.get_session() as session:  # ç‹¬ç«‹äº‹åŠ¡
            result = strategy.execute(session)
            strategy.mark_run(current_time)
            self._notify_observers(result)
            results.append(result)
    
    return results
```

**ä¼˜åŠ¿**ï¼š
- âœ… äº‹åŠ¡éš”ç¦» - ä¸€ä¸ªç­–ç•¥å¤±è´¥ä¸å½±å“å…¶ä»–
- âœ… å‡å°‘ session æŒæœ‰æ—¶é—´
- âœ… æ›´å¥½çš„å¹¶å‘æ€§èƒ½
- âœ… æ›´ç»†ç²’åº¦çš„äº‹åŠ¡æ§åˆ¶

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µ 1: æ’åºç¼“å­˜ä¼˜åŒ–ï¼ˆç«‹å³ï¼‰

1. æ·»åŠ ç¼“å­˜æœºåˆ¶
2. åœ¨ register/unregister æ—¶å¤±æ•ˆç¼“å­˜
3. ä½¿ç”¨æƒ°æ€§è®¡ç®—

### é˜¶æ®µ 2: æŸ¥è¯¢é‡å¤ä¼˜åŒ–ï¼ˆç«‹å³ï¼‰

1. ç§»é™¤ before_execute ä¸­çš„ count æŸ¥è¯¢
2. æˆ–è€…åˆå¹¶æŸ¥è¯¢é€»è¾‘

### é˜¶æ®µ 3: äº‹åŠ¡ä¼˜åŒ–ï¼ˆç«‹å³ï¼‰

1. æ¯ä¸ªç­–ç•¥ä½¿ç”¨ç‹¬ç«‹ session
2. å‡å°‘ session æŒæœ‰æ—¶é—´

### é˜¶æ®µ 4: æ–‡ä»¶æ‹†åˆ†ï¼ˆä¸­æœŸï¼‰

1. åˆ›å»ºæ–°ç›®å½•ç»“æ„
2. æ‹†åˆ†æ–‡ä»¶
3. æ›´æ–°å¯¼å…¥

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

| ä¼˜åŒ–é¡¹ | é¢„æœŸæå‡ | å®ç°éš¾åº¦ |
|--------|----------|----------|
| æ’åºç¼“å­˜ | 50-80% æ’åºæ—¶é—´å‡å°‘ | â­â­ |
| æ¶ˆé™¤é‡å¤æŸ¥è¯¢ | 30-50% æŸ¥è¯¢æ—¶é—´å‡å°‘ | â­â­ |
| äº‹åŠ¡ä¼˜åŒ– | å‡å°‘è¿æ¥å ç”¨ 40-60% | â­â­ |
| æ–‡ä»¶æ‹†åˆ† | å¯ç»´æŠ¤æ€§æå‡ | â­â­ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹** - ä¿æŒæ¥å£ä¸å˜
2. **æµ‹è¯•è¦†ç›–** - ç¡®ä¿åŠŸèƒ½æ­£ç¡®
3. **æ€§èƒ½æµ‹è¯•** - éªŒè¯ä¼˜åŒ–æ•ˆæœ
4. **é€æ­¥è¿ç§»** - åˆ†é˜¶æ®µå®æ–½

