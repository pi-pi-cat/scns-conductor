# Worker å®¹é”™æœºåˆ¶æ€»ç»“

## ğŸ¯ æ‚¨çš„é—®é¢˜è§£ç­”

### Q1: Worker å¼‚å¸¸é€€å‡ºä¼šå¯¼è‡´ä½œä¸šä¸¢å¤±å—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸ä¼šä¸¢å¤±ï¼Œä½†ä¼šè¢«æ ‡è®°ä¸ºå¤±è´¥**

- âœ… ä½œä¸šçŠ¶æ€å­˜å‚¨åœ¨ PostgreSQL æ•°æ®åº“ä¸­ï¼Œä¸ä¼šä¸¢å¤±
- âœ… Worker é‡å¯æ—¶ä¼šè‡ªåŠ¨æ£€æµ‹å­¤å„¿ä½œä¸š
- âœ… å­¤å„¿ä½œä¸šä¼šè¢«æ ‡è®°ä¸º `FAILED` çŠ¶æ€
- âœ… èµ„æºä¼šè¢«è‡ªåŠ¨é‡Šæ”¾

### Q2: Worker å¼‚å¸¸é€€å‡ºä¼šå¯¼è‡´ä½œä¸šé‡æ–°è¿è¡Œå—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸ä¼šé‡å¤æ‰§è¡Œ**

- âœ… ä½œä¸šçŠ¶æ€ç”±æ•°æ®åº“æ§åˆ¶ï¼Œä¸ä¼šå›  Worker é‡å¯è€Œé‡å¤
- âœ… å·²å®Œæˆçš„ä½œä¸šçŠ¶æ€æ˜¯ `COMPLETED`ï¼Œä¸ä¼šé‡æ–°æ‰§è¡Œ
- âœ… å¤±è´¥çš„ä½œä¸šéœ€è¦ç”¨æˆ·**æ˜¾å¼é‡æ–°æäº¤**æ‰ä¼šå†æ¬¡æ‰§è¡Œ

### Q3: å¦‚ä½•ç¡®ä¿ä½œä¸šè¡Œä¸ºï¼ˆé‡è¯• vs ä¸¢å¼ƒï¼‰ï¼Ÿ

**ç­”æ¡ˆï¼šæŒ‰ç…§ä»¥ä¸‹ç­–ç•¥**

| æƒ…å†µ | Worker è¡Œä¸º | ä½œä¸šçŠ¶æ€ | ç”¨æˆ·æ“ä½œ |
|------|------------|---------|---------|
| Worker æ­£å¸¸è¿è¡Œ | ä½œä¸šå®Œæˆ | `COMPLETED` | æ— éœ€æ“ä½œ |
| Worker å´©æºƒï¼Œä½œä¸šå·²å®Œæˆ | æ— å½±å“ | `COMPLETED` | æ— éœ€æ“ä½œ |
| Worker å´©æºƒï¼Œä½œä¸šæœªå®Œæˆ | æ ‡è®°å¤±è´¥ | `FAILED` | **ç”¨æˆ·å†³å®š**æ˜¯å¦é‡æ–°æäº¤ |
| ä½œä¸šè¶…æ—¶ | è‡ªåŠ¨ç»ˆæ­¢ | `FAILED` | ç”¨æˆ·å¯é‡æ–°æäº¤ |
| ä½œä¸šè„šæœ¬é”™è¯¯ | è®°å½•é”™è¯¯ | `FAILED` | ä¿®å¤è„šæœ¬åé‡æ–°æäº¤ |

**é‡è¦åŸåˆ™**ï¼š**ç³»ç»Ÿä¸ä¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„ä½œä¸š**ï¼Œé¿å…é‡å¤æ‰§è¡Œå¯¼è‡´çš„å‰¯ä½œç”¨ã€‚

### Q4: é‡å¯ Worker ä¼šè¿è¡Œåƒåœ¾ä½œä¸šå—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸ä¼šï¼Œæœ‰å®Œæ•´çš„ä¿æŠ¤æœºåˆ¶**

1. **å¯åŠ¨æ¢å¤æ£€æŸ¥**
   ```python
   def recover_on_startup():
       # æ£€æŸ¥æ‰€æœ‰ RUNNING çŠ¶æ€çš„ä½œä¸š
       # å¦‚æœè¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ ‡è®°ä¸º FAILED
       # é‡Šæ”¾èµ„æº
   ```

2. **çŠ¶æ€ä¸€è‡´æ€§**
   - æ•°æ®åº“æ˜¯å”¯ä¸€çœŸç›¸æº
   - Worker åªæ‰§è¡ŒçŠ¶æ€ä¸º `PENDING` çš„ä½œä¸š
   - å·²ç»æ˜¯ `COMPLETED`/`FAILED` çš„ä½œä¸šä¸ä¼šè¢«è§¦ç¢°

3. **å¹‚ç­‰æ€§ä¿è¯**
   - èµ„æºé‡Šæ”¾æ“ä½œå¯ä»¥å¤šæ¬¡è°ƒç”¨
   - ä½œä¸šå–æ¶ˆæ“ä½œå¯ä»¥å¤šæ¬¡è°ƒç”¨
   - ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨

---

## ğŸ”§ å®¹é”™æœºåˆ¶å·¥ä½œæµç¨‹

### Worker å¯åŠ¨æµç¨‹

```
1. åˆå§‹åŒ–é…ç½®å’Œæ—¥å¿—
   â†“
2. è¿æ¥æ•°æ®åº“å’Œ Redis
   â†“
3. ã€å…³é”®ã€‘æ‰§è¡Œæ•…éšœæ¢å¤
   â”œâ”€ æŸ¥è¯¢æ‰€æœ‰ RUNNING çŠ¶æ€çš„ä½œä¸š
   â”œâ”€ å¯¹æ¯ä¸ªä½œä¸šæ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
   â”œâ”€ ä¸å­˜åœ¨ â†’ æ ‡è®°ä¸º FAILED + é‡Šæ”¾èµ„æº
   â””â”€ å­˜åœ¨ â†’ ä¿æŒ RUNNINGï¼ˆä½†æ— æ³•æ§åˆ¶ï¼Œè§é™åˆ¶ï¼‰
   â†“
4. å¯åŠ¨è°ƒåº¦å™¨å®ˆæŠ¤è¿›ç¨‹
   â†“
5. å¯åŠ¨ RQ Workerï¼Œå¤„ç†æ–°ä½œä¸š
```

### ä½œä¸šæ‰§è¡Œæµç¨‹ï¼ˆå¸¦è¿›ç¨‹è¿½è¸ªï¼‰

```
ç”¨æˆ·æäº¤ä½œä¸š
   â†“
API åˆ›å»ºè®°å½• (state=PENDING)
   â†“
è°ƒåº¦å™¨æ£€æµ‹åˆ° PENDING ä½œä¸š
   â†“
åˆ†é…èµ„æº (state=RUNNING)
   â†“
Executor æ‰§è¡Œè„šæœ¬
   â”œâ”€ åˆ›å»ºè¿›ç¨‹ (pid=12345)
   â”œâ”€ ã€å…³é”®ã€‘å­˜å‚¨ pid åˆ°æ•°æ®åº“
   â”œâ”€ ç›‘æ§æ‰§è¡Œ
   â””â”€ ç­‰å¾…å®Œæˆ
   â†“
æ›´æ–°çŠ¶æ€ (COMPLETED/FAILED)
   â†“
é‡Šæ”¾èµ„æº
```

---

## ğŸ“Š æ•…éšœåœºæ™¯å¤„ç†è¡¨

| åœºæ™¯ | å‘ç”Ÿæ—¶æœº | ç³»ç»Ÿè¡Œä¸º | æœ€ç»ˆçŠ¶æ€ | ç”¨æˆ·æ“ä½œ |
|------|---------|---------|---------|---------|
| **æ­£å¸¸å®Œæˆ** | æ‰§è¡Œç»“æŸ | æ ‡è®° COMPLETED | âœ… COMPLETED | æ— éœ€æ“ä½œ |
| **è„šæœ¬é”™è¯¯** | æ‰§è¡Œä¸­ | æ•è·é”™è¯¯ | âŒ FAILED | ä¿®å¤åé‡æ–°æäº¤ |
| **è¶…æ—¶** | è¾¾åˆ°æ—¶é—´é™åˆ¶ | ç»ˆæ­¢è¿›ç¨‹ | âŒ FAILED | å¢åŠ æ—¶é™åé‡æ–°æäº¤ |
| **Worker å´©æºƒ** | æ‰§è¡Œä¸­ | å¯åŠ¨æ—¶æ£€æµ‹ | âŒ FAILED | æ£€æŸ¥åå†³å®šæ˜¯å¦é‡æ–°æäº¤ |
| **æœåŠ¡å™¨å®•æœº** | ä»»ä½•æ—¶å€™ | é‡å¯åæ£€æµ‹ | âŒ FAILED | æ£€æŸ¥åå†³å®šæ˜¯å¦é‡æ–°æäº¤ |
| **æ‰‹åŠ¨å–æ¶ˆ** | ç”¨æˆ·è¯·æ±‚ | ç»ˆæ­¢è¿›ç¨‹ | ğŸš« CANCELLED | æ— éœ€æ“ä½œ |

---

## ğŸ›¡ï¸ å®‰å…¨ä¿è¯

### 1. ä¸ä¼šä¸¢å¤±ä½œä¸š

```
æ‰€æœ‰çŠ¶æ€ â†’ PostgreSQL
              â†“
        æŒä¹…åŒ–å­˜å‚¨
              â†“
        Worker é‡å¯åä»ç„¶å¯è§
```

### 2. ä¸ä¼šé‡å¤æ‰§è¡Œ

```
ä½œä¸šçŠ¶æ€æ£€æŸ¥
  â”œâ”€ PENDING â†’ å¯ä»¥æ‰§è¡Œ
  â”œâ”€ RUNNING â†’ æ¢å¤æ£€æŸ¥ï¼ˆä¸ä¼šé‡æ–°æ‰§è¡Œï¼‰
  â”œâ”€ COMPLETED â†’ å¿½ç•¥
  â”œâ”€ FAILED â†’ å¿½ç•¥ï¼ˆéœ€ç”¨æˆ·é‡æ–°æäº¤ï¼‰
  â””â”€ CANCELLED â†’ å¿½ç•¥
```

### 3. èµ„æºä¸ä¼šæ³„æ¼

```
å¯åŠ¨æ—¶æ¢å¤
  â†“
æ£€æŸ¥æ‰€æœ‰ RUNNING ä½œä¸š
  â†“
é‡Šæ”¾å­¤å„¿ä½œä¸šçš„èµ„æº
  â†“
èµ„æºæ± çŠ¶æ€æ­£ç¡®
```

### 4. æ“ä½œå¹‚ç­‰æ€§

```python
# å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œå®‰å…¨
release_resources(job_id)
release_resources(job_id)  # ä¸ä¼šå‡ºé”™

cancel_job(job_id)
cancel_job(job_id)  # ä¸ä¼šå‡ºé”™
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

### é™åˆ¶ 1ï¼šæ— æ³•æ§åˆ¶å­¤å„¿è¿›ç¨‹

**åœºæ™¯**ï¼šWorker å´©æºƒæ—¶ï¼Œä½œä¸šè¿›ç¨‹å¯èƒ½ç»§ç»­è¿è¡Œ

```
Worker å´©æºƒ
  â†“
ä½œä¸šè¿›ç¨‹ (PID=12345) ç»§ç»­è¿è¡Œ
  â†“
é‡å¯ Worker
  â†“
æ£€æµ‹åˆ°è¿›ç¨‹å­˜åœ¨ â†’ ä¿æŒ RUNNING çŠ¶æ€
  â†“
ä½†æ˜¯ï¼æ— æ³•å†æ§åˆ¶è¿™ä¸ªè¿›ç¨‹ï¼š
  - æ— æ³•è·å–è¾“å‡ºæ—¥å¿—
  - æ— æ³•å‘é€ç»ˆæ­¢ä¿¡å·
  - æ— æ³•æ£€æµ‹æ˜¯å¦å®Œæˆ
```

**å»ºè®®å¤„ç†**ï¼š
1. æ‰‹åŠ¨æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
2. å¦‚æœè¿›ç¨‹å·²å®Œæˆï¼Œæ‰‹åŠ¨æ›´æ–°ä½œä¸šçŠ¶æ€
3. å¦‚æœè¿›ç¨‹éœ€è¦ç»ˆæ­¢ï¼Œæ‰‹åŠ¨ kill

```bash
# æŸ¥æ‰¾å­¤å„¿è¿›ç¨‹
ps aux | grep job_12345.sh

# æ‰‹åŠ¨ç»ˆæ­¢
kill -9 12345

# æ›´æ–°æ•°æ®åº“
UPDATE jobs SET state='FAILED', end_time=NOW() WHERE id=12345;
UPDATE resource_allocations SET released=TRUE WHERE job_id=12345;
```

### é™åˆ¶ 2ï¼šæ—¥å¿—å¯èƒ½ä¸å®Œæ•´

- Worker å´©æºƒå‰çš„æ—¥å¿—å·²å†™å…¥æ–‡ä»¶ âœ…
- Worker å´©æºƒåçš„æ—¥å¿—æ— æ³•æ•è· âŒ

### é™åˆ¶ 3ï¼šéœ€è¦å®šæœŸæ¸…ç†

é•¿æ—¶é—´è¿è¡Œåå¯èƒ½ç§¯ç´¯é™ˆæ—§æ•°æ®ï¼Œå»ºè®®å®šæœŸè¿è¡Œï¼š

```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
0 2 * * * python /app/scripts/cleanup.py
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç›‘æ§å‘Šè­¦

```python
# ç›‘æ§å­¤å„¿ä½œä¸šæ•°é‡
if len(orphan_jobs) > 10:
    send_alert("æ£€æµ‹åˆ°å¤§é‡å­¤å„¿ä½œä¸š")
```

### 2. å®šæœŸæ¸…ç†

```python
# æ¸…ç†48å°æ—¶å‰çš„å·²å®Œæˆä½œä¸šèµ„æº
recovery_manager.cleanup_stale_allocations(max_age_hours=48)
```

### 3. å¥åº·æ£€æŸ¥

```bash
# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * python /app/scripts/health_check.py
```

### 4. æ—¥å¿—å®¡è®¡

```python
# è®°å½•æ‰€æœ‰æ¢å¤æ“ä½œ
logger.info(f"æ¢å¤æ£€æŸ¥ï¼šæ ‡è®°äº† {count} ä¸ªå­¤å„¿ä½œä¸šä¸º FAILED")
```

### 5. è‡ªåŠ¨é‡å¯

```yaml
# docker-compose.yml
worker:
  restart: always
  deploy:
    restart_policy:
      condition: on-failure
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†å®ç°**ï¼šå‚è§ `FAULT_TOLERANCE.md`
- **æ¢å¤æ¨¡å—**ï¼šå‚è§ `worker/recovery.py`
- **Worker å¯åŠ¨**ï¼šå‚è§ `worker/main.py`

---

**æ›´æ–°æ—¶é—´**: 2025-11-07  
**ç‰ˆæœ¬**: v1.0.1
